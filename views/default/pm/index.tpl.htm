<?php TPL::include('global/header.tpl.htm'); ?>

<div class="aw-container-wrap">
	<div class="container">
		<div class="row">
			<div class="aw-content-wrap clearfix">
				<div class="col-sm-12 col-md-9 aw-main-content">
					<div class="aw-mod aw-inbox">
						<div class="mod-head common-head">
							<h2>
								<a href="javascript:;" onclick="" class="pull-right btn btn-mini btn-success"><?php _e('新私信'); ?></a>
								<span class="pull-right aw-setting-inbox hidden-xs"><a class="aw-small-text" href="<?php echo url_rewrite(); ?>/profile/privacy/#!inbox"><i class="icon icon-setting"></i> <?php _e('私信设置'); ?></a></span>
								<?php _e('私信'); ?>
							</h2>
						</div>
						<div class="mod-body aw-feed-list">
						<?php if ($this->list) { ?>
							<?php foreach($this->list as $key => $val) { ?>
							<div class="aw-item <?php if ($val['unread']) { ?>active<?php } ?>">
								<div style="position:relative;padding-left:50px;">
									<div style="position:absolute;left:0;top:5px;width:50px;height:50px;line-height:0;overflow:hidden;"><!--
									<?php $valid_member_count = count($val['users']); ?>
									<?php foreach($val['users'] as $user) { ?>
										<?php if ($valid_member_count > 1 AND $user['uid'] == $this->user_id) continue; ?>
										--><a href="<?php echo UF::url($user); ?>"><img style="<?php if ($val['member_count'] <= 2) { ?>width:40px;height:40px;<?php } else { ?>width:20px;height:20px;<?php } ?>border-radius:4px;" src="<?php echo UF::avatar($user, 'mid'); ?>" alt="" /></a><!--
									<?php } ?>
									--></div>

									<a class="aw-small-text" href="<?php echo url_rewrite(); ?>/pm/read/<?php echo $val['id']; ?>">
									<?php foreach($val['users'] as $user) { ?>
										<?php if ($user['uid'] == $this->user_id) continue; ?>
										<?php echo UF::name($user); ?>
									<?php } ?>
									</a>

									<p class="content">
									<?php if ($val['last_message']) { ?>
										<a class="pm_message" data-message="<?php echo safe_text($val['last_message']['message']); ?>" href="<?php echo url_rewrite(); ?>/pm/read/<?php echo $val['id']; ?>"><i><?php _e('待解密'); ?></i></a>
									<?php } else if ($val['unread']) {?>
										<s><?php _e('已刪除'); ?></s>
									<?php } ?>
									</p>

									<p class="aw-small-text">
										<span class="pull-right">
										<?php if ($val['unread']) { ?>
											<a href="<?php echo url_rewrite(); ?>/pm/read/<?php echo $val['id']; ?>"><?php _e('有 %s 条新私信', $val['unread']); ?></a>
											&nbsp;
											<a class="aw-small-text" href="<?php echo url_rewrite(); ?>/pm/read/<?php echo $val['id']; ?>"><?php _e('查看'); ?></a>
										<?php } else { ?>
											<a class="aw-small-text" href="javascript:;" onclick=""><?php _e('删除'); ?></a>
										<?php } ?>
										</span>
										<a class="aw-small-text" href="<?php echo url_rewrite(); ?>/pm/read/<?php echo $val['id']; ?>"><?php echo date_friendly($val['update_time']); ?></a>
									</p>
								</div>
							</div>
							<?php } ?>
						<?php } ?>
						</div>
						<div class="mod-footer">
							<?php TPL::include('global/pagination.tpl.htm'); ?>
						</div>
					</div>
				</div>
				<!-- 侧边栏 -->
				<div class="col-sm-12 col-md-3 aw-side-bar">
					<?php TPL::include('block/sidebar_menu.tpl.htm'); ?>
				</div>
				<!-- end 侧边栏 -->
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
$(document).ready(function () {
	function truncate(s) {
		var n = 60;
		if (s.length <= n) return s;
		return s.substr(0, n) + '...';
	}

	function decrypt_key(cb) {
		var public_key = '<?php echo $this->user_info['public_key']; ?>';
		if (!public_key) {
			AWS.alert(_t('缺少公钥和私钥, 请重新登录以生成新的公钥和私钥'));
			return;
		}
		AWS.passwordPrompt(_t('请输入登录密码以解密私钥'), function(pwd) {
			PasswordUtil.password_hash(pwd, public_key).then(function(value) {
				return PasswordUtil.decrypt_private_key('<?php echo $this->user_info['private_key']; ?>', value);
			}).then(function(value) {
				cb(value);
			}).catch(function(error) {
				console.log(error);
				AWS.confirm(_t('无法解密私钥, 要再试一次吗？'), function() {
					decrypt_key(cb);
				});
			});
		});
	}

	function read_key() {
		var k = '<?php echo G_COOKIE_PREFIX; ?>_private_key';
		return new Promise(function(resolve) {
			var private_key = localStorage.getItem(k);
			if (!private_key) {
				decrypt_key(function(private_key) {
					localStorage.setItem(k, private_key);
					resolve(private_key);
				});
			} else {
				resolve(private_key);
			}
		}).then(function(value) {
			return PasswordUtil.read_private_key(value);
		}).catch(function(error) {
			localStorage.removeItem(k);
			throw error;
		});
	}

	read_key().then(function(private_key) {
		$('.pm_message').each(function() {
			var el = $(this);
			var msg = el.data('message');
			if (!msg) return;
			PasswordUtil.decrypt(msg, private_key).then(function(value) {
				el.text(truncate(value));
			}).catch(function(error) {
				console.log(error);
				el.html('<i>' + _t('无法解密这一条私信') + '</i>');
			});
		});
	}).catch(function(error) {
		console.log(error);
		AWS.alert(_t('无法读取私钥, 请刷新页面重试'));
	});

});
</script>

<?php TPL::include('global/footer.tpl.htm'); ?>